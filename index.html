<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafePing Corrected</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html {
            background-color: #0b141a;
            height: 100%; width: 100%;
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #e9edef;
            overflow: hidden;
        }

        #app { width: 100%; height: 100%; position: relative; }

        /* --- INVISIBLE TRIGGER ZONES (Top Left/Right) --- */
        .trigger-zone-left { position: absolute; top: 0; left: 0; width: 80px; height: 60px; z-index: 9999; cursor: pointer; }
        .trigger-zone-right { position: absolute; top: 0; right: 0; width: 80px; height: 60px; z-index: 9999; cursor: pointer; }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; background: #0b141a;
        }
        .screen.active { display: flex; z-index: 10; }

        /* CHAT SCREEN OVERLAY (Higher Z-Index) */
        #screen-chat { z-index: 50; }

        /* --- HEADER --- */
        .app-header {
            height: 60px; background: #1f2c34; display: flex; align-items: center;
            justify-content: space-between; padding: 0 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .app-title { font-size: 20px; color: #fff; font-weight: 600; }

        /* --- CONTACT LIST --- */
        .content { flex: 1; overflow-y: auto; position: relative; }
        .contact-item {
            display: flex; align-items: center; padding: 15px;
            border-bottom: 1px solid rgba(134,150,160,0.15); cursor: pointer;
        }
        .contact-item:active { background: #202c33; }
        .avatar {
            width: 50px; height: 50px; border-radius: 50%; background: #667781;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: white; flex-shrink: 0;
        }

        /* --- TAB BAR --- */
        .tab-bar {
            height: 60px; background: #1f2c34; display: flex; border-top: 1px solid #333; flex-shrink: 0;
        }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8696a0; }
        .tab.active { color: #00a884; }
        .tab i { font-size: 24px; margin-bottom: 4px; }
        .tab span { font-size: 12px; }

        /* --- CHAT AREA --- */
        #chat-bg {
            min-height: 100%;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; background-color: #0b141a;
            padding: 15px; display: flex; flex-direction: column; gap: 8px;
        }

        /* MESSAGES - LEFT VS RIGHT */
        .msg { 
            max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 16px; 
            color: white; line-height: 1.4; position: relative; word-wrap: break-word; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        /* RECEIVER (THEM) -> LEFT */
        .msg.in { 
            background: #1f2c34; 
            align-self: flex-start; 
            border-top-left-radius: 0; 
        }
        
        /* SENDER (YOU/AUTO) -> RIGHT */
        .msg.out { 
            background: #005c4b; 
            align-self: flex-end; 
            border-top-right-radius: 0; 
        }

        /* CHAT FOOTER */
        .chat-footer {
            height: 65px; background: #1f2c34; display: flex; align-items: center;
            padding: 5px 10px; flex-shrink: 0;
        }
        .chat-input-box {
            flex: 1; background: #2a3942; border-radius: 25px; padding: 10px 20px;
            display: flex; align-items: center; margin-right: 8px;
        }
        #msg-input { width: 100%; background: transparent; border: none; color: white; font-size: 16px; }
        .send-circle {
            width: 45px; height: 45px; background: #00a884; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 18px; color: white;
        }

        /* --- SETTINGS --- */
        .config-card { background: #1f2c34; margin: 15px; padding: 15px; border-radius: 12px; }
        .full-input { width: 100%; background: #2a3942; border: 1px solid #374045; color: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 16px; }
        .btn-save { background: #00a884; color: #111; font-weight: bold; border: none; padding: 14px; width: 100%; border-radius: 25px; font-size: 16px; margin: 15px 0; }
        #map-wrapper { height: 200px; width: 100%; border-radius: 8px; margin-bottom: 10px; position: relative; }
        #map-obj { height: 100%; width: 100%; }

        /* AUTO ALERT */
        .auto-alert {
            width: 90%; align-self: center; background: rgba(0, 168, 132, 0.2);
            border: 1px solid #00a884; border-radius: 10px; padding: 12px;
            text-align: center; margin: 10px 0;
        }
        .mini-map { width: 100%; height: 100px; background: #333; margin-top: 5px; background-size: cover; background-position: center; border-radius: 5px; }

    </style>
</head>
<body>

<div id="app">

    <div class="trigger-zone-left" onclick="triggerLocationEvent()"></div>
    <div class="trigger-zone-right" onclick="triggerBatteryEvent()"></div>

    <div id="screen-home" class="screen active">
        <div class="app-header">
            <span class="app-title">SafePing</span>
            <i class="fas fa-search" style="color:#8696a0; font-size:20px;"></i>
        </div>
        
        <div class="content">
            <div id="contact-list"></div>
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('home')">
                <i class="fas fa-comment-alt"></i><span>Chats</span>
            </div>
            <div class="tab" onclick="switchTab('config')">
                <i class="fas fa-cog"></i><span>Settings</span>
            </div>
        </div>
    </div>

    <div id="screen-config" class="screen">
        <div class="app-header"><span class="app-title">Settings</span></div>
        <div class="content" style="padding:10px;">
            <div class="config-card">
                <span style="color:#ef4444; font-weight:bold; font-size:14px;"><i class="fas fa-battery-quarter"></i> BATTERY PROTOCOL</span>
                <div style="display:flex; justify-content:space-between; margin:10px 0; align-items:center;">
                    <input type="range" min="1" max="20" value="10" style="width:70%" oninput="document.getElementById('b-val').innerText=this.value+'%'">
                    <span id="b-val" style="color:#ef4444; font-weight:bold;">10%</span>
                </div>
                <select id="batt-contact" class="full-input"></select>
                <input type="text" id="batt-msg" class="full-input" value="Battery Low. Call Landline.">
            </div>
            <div class="config-card">
                <span style="color:#00a884; font-weight:bold; font-size:14px;"><i class="fas fa-map-marker-alt"></i> LOCATION PROTOCOL</span>
                <div id="map-wrapper">
                    <div style="position:absolute; top:10px; left:10px; right:10px; display:flex; gap:5px; z-index:500;">
                        <input type="text" id="loc-search" placeholder="City..." style="flex:1; padding:8px; border-radius:4px; border:none;">
                        <button onclick="searchLoc()" style="background:#00a884; border:none; color:white; padding:0 10px; border-radius:4px;">Go</button>
                    </div>
                    <div id="map-obj"></div>
                </div>
                <select id="loc-contact" class="full-input"></select>
                <input type="text" id="loc-msg" class="full-input" value="I have reached safely.">
            </div>
            <button class="btn-save" onclick="saveRules()">SAVE RULES</button>
            <div style="height:50px"></div>
        </div>
        <div class="tab-bar">
            <div class="tab" onclick="switchTab('home')"><i class="fas fa-comment-alt"></i><span>Chats</span></div>
            <div class="tab active" onclick="switchTab('config')"><i class="fas fa-cog"></i><span>Settings</span></div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div class="app-header">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-arrow-left" onclick="closeChat()" style="font-size:24px; margin-right:20px; cursor:pointer; padding: 5px;"></i>
                <div class="avatar" id="chat-av" style="width:35px; height:35px; font-size:14px; margin-right:10px;"></div>
                <div>
                    <div id="chat-title" style="font-weight:bold; font-size:16px;">Name</div>
                    <div style="font-size:12px; color:#8696a0">online</div>
                </div>
            </div>
        </div>

        <div class="content" id="chat-scroll">
            <div id="chat-bg">
                <div id="msg-list"></div>
            </div>
        </div>

        <div class="chat-footer">
            <div class="chat-input-box">
                <input type="text" id="msg-input" placeholder="Message" autocomplete="off">
            </div>
            <div class="send-circle" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

</div>

<script>
    const DB = [
        {name:"Mom ‚ù§Ô∏è", color:"#e91e63", last:"Be safe."},
        {name:"Dad", color:"#3b82f6", last:"Okay."},
        {name:"Rahul", color:"#f59e0b", last:"Where r u?"},
        {name:"Priya", color:"#8b5cf6", last:"See you."},
        {name:"Amit", color:"#10b981", last:"Notes?"},
        {name:"Emergency", color:"#ef4444", last:"Active"}
    ];

    let map, marker, activeContact, rulesActive = false;
    let config = { batt: { to:"Mom ‚ù§Ô∏è", msg:"Low Battery"}, loc: { to:"Dad", msg:"Reached"} };

    window.onload = () => {
        renderList(DB);
        const opts = DB.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        document.getElementById('batt-contact').innerHTML = opts;
        document.getElementById('loc-contact').innerHTML = opts;
    };

    function renderList(list) {
        const div = document.getElementById('contact-list');
        div.innerHTML = "";
        list.forEach(c => {
            const el = document.createElement('div');
            el.className = 'contact-item';
            el.onclick = () => openChat(c.name); // Chat opens anytime
            el.innerHTML = `
                <div class="avatar" style="background:${c.color}">${c.name[0]}</div>
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:16px; margin-bottom:2px;">${c.name}</div>
                    <div style="color:#8696a0; font-size:14px;">${c.last}</div>
                </div>
            `;
            div.appendChild(el);
        });
    }

    // --- NAVIGATION ---
    function switchTab(t) {
        document.getElementById('screen-home').classList.remove('active');
        document.getElementById('screen-config').classList.remove('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        
        if(t==='home') {
            document.getElementById('screen-home').classList.add('active');
            document.querySelectorAll('.tab')[0].classList.add('active');
        } else if(t==='config') {
            document.getElementById('screen-config').classList.add('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
            setTimeout(initMap, 200);
        }
    }

    // --- CHAT LOGIC ---
    function openChat(name) {
        activeContact = name;
        const c = DB.find(x => x.name === name);
        
        // Hide others, Show Chat
        document.getElementById('screen-home').classList.remove('active');
        document.getElementById('screen-config').classList.remove('active');
        document.getElementById('screen-chat').classList.add('active');

        document.getElementById('chat-title').innerText = c.name;
        document.getElementById('chat-av').innerText = c.name[0];
        document.getElementById('chat-av').style.background = c.color;
        
        // Reset Chat
        document.getElementById('msg-list').innerHTML = `
            <div class="msg in">Hey ${name.split(' ')[0]} here.</div>
            <div class="msg out">${c.last}</div>
        `;
    }

    function closeChat() {
        // Go back to Home
        document.getElementById('screen-chat').classList.remove('active');
        document.getElementById('screen-home').classList.add('active');
        // Ensure Tabs are correct
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab')[0].classList.add('active');
    }

    // --- RULES ---
    function saveRules() {
        config.batt.to = document.getElementById('batt-contact').value;
        config.batt.msg = document.getElementById('batt-msg').value;
        config.loc.to = document.getElementById('loc-contact').value;
        config.loc.msg = document.getElementById('loc-msg').value;
        rulesActive = true;
        alert("Rules Saved!");
        switchTab('home');
    }

    // --- MESSAGING ---
    function sendMsg() {
        const inp = document.getElementById('msg-input');
        if(!inp.value) return;
        addMsg(inp.value, 'out');
        inp.value = "";
    }

    function addMsg(txt, type, isHTML=false) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        if(isHTML) div.innerHTML = txt; else div.innerText = txt;
        document.getElementById('msg-list').appendChild(div);
        
        // Auto-Scroll
        const scroll = document.getElementById('chat-scroll');
        scroll.scrollTop = scroll.scrollHeight;
    }

    // --- TRIGGERS ---
    function triggerLocationEvent() {
        if(!rulesActive) return alert("Please Save Rules in Settings first.");
        if(activeContact !== config.loc.to) openChat(config.loc.to);
        
        addMsg(`
            <div class="auto-alert">
                <b style="color:#00a884">üìç ARRIVED</b><br>
                <div style="font-size:14px; color:#e9edef; margin-top:5px;">${config.loc.msg}</div>
                <div class="mini-map" style="background-image:url('https://a.basemaps.cartocdn.com/dark_all/13/5000/3000.png')"></div>
            </div>
        `, 'out', true); // 'out' puts it on the RIGHT (Green)
    }

    function triggerBatteryEvent() {
        if(!rulesActive) return alert("Please Save Rules in Settings first.");
        if(activeContact !== config.batt.to) openChat(config.batt.to);

        addMsg(`
            <div class="auto-alert" style="border-color:#ef4444; background:rgba(239,68,68,0.2)">
                <b style="color:#ef4444">‚ö° LOW BATTERY</b><br>
                <div style="font-size:14px; color:#e9edef; margin-top:5px;">${config.batt.msg}</div>
            </div>
        `, 'out', true); // 'out' puts it on the RIGHT (Green)
    }

    // --- MAP ---
    function initMap() {
        if(map) { map.invalidateSize(); return; }
        map = L.map('map-obj').setView([20.59, 78.96], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution:''}).addTo(map);
        map.on('click', e => { if(marker) map.removeLayer(marker); marker = L.marker(e.latlng).addTo(map); });
    }
    function searchLoc() {
        const q = document.getElementById('loc-search').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`).then(r=>r.json()).then(d=>{
            if(d.length){ map.setView([d[0].lat, d[0].lon], 13); if(marker)map.removeLayer(marker); marker=L.marker([d[0].lat, d[0].lon]).addTo(map); }
        });
    }

</script>
</body>
</html>
