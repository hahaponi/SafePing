<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafePing Final Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html {
            background-color: #0b141a;
            height: 100%; width: 100%;
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #e9edef;
            overflow: hidden;
            position: fixed;
        }

        #app { width: 100%; height: 100%; position: relative; display: flex; flex-direction: column; }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b141a; display: none; flex-direction: column;
            z-index: 10;
        }
        .screen.active { display: flex; }

        /* CHAT SCREEN */
        #screen-chat { z-index: 100; background: #0b141a; }

        /* --- HEADER --- */
        .header {
            height: 60px; background: #1f2c34; display: flex; align-items: center;
            justify-content: space-between; padding: 0 15px; flex-shrink: 0;
            z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .title { font-size: 20px; font-weight: 600; color: white; }

        /* --- BACK BUTTON --- */
        .back-click-area {
            padding: 10px 30px 10px 0;
            cursor: pointer; display: flex; align-items: center;
        }

        /* --- CONTENT SCROLL --- */
        .content { flex: 1; overflow-y: auto; position: relative; }

        /* --- TABS --- */
        .tabs { height: 60px; background: #1f2c34; display: flex; border-top: 1px solid #333; flex-shrink: 0; }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8696a0; }
        .tab.active { color: #00a884; }
        .tab i { font-size: 24px; margin-bottom: 4px; }

        /* --- CONTACT LIST --- */
        .contact-item {
            display: flex; align-items: center; padding: 15px;
            border-bottom: 1px solid rgba(134,150,160,0.15); cursor: pointer;
        }
        .contact-item:active { background: #202c33; }
        .avatar {
            width: 50px; height: 50px; border-radius: 50%; background: #667781;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: white; flex-shrink: 0;
        }

        /* --- SETTINGS --- */
        .card { background: #1f2c34; margin: 15px; padding: 15px; border-radius: 12px; }
        .full-inp { width: 100%; background: #2a3942; border: 1px solid #374045; color: white; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 16px; }
        
        /* --- GOOGLE MAPS STYLE CONTAINER --- */
        #map-box { height: 250px; width: 100%; border-radius: 8px; margin: 10px 0; position: relative; }
        
        /* SEARCH BAR INSIDE MAP */
        .map-search-container {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; gap: 5px; z-index: 500;
        }
        .map-input {
            flex: 1; background: white; color: black; border: none;
            padding: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 14px;
        }
        .map-go-btn {
            background: #4285F4; color: white; border: none;
            padding: 0 15px; border-radius: 4px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* CURRENT LOCATION BUTTON (GPS) */
        .gps-btn {
            position: absolute; bottom: 10px; right: 10px;
            width: 40px; height: 40px; background: white;
            border-radius: 50%; z-index: 500;
            display: flex; align-items: center; justify-content: center;
            color: #666; font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer;
        }
        .gps-btn:active { background: #f0f0f0; }

        /* TEST BUTTONS */
        .test-btn { background:#2a3942; color:#00a884; border:1px solid #00a884; padding:12px; width:100%; border-radius:8px; font-weight:bold; margin-bottom:10px; }

        /* --- CHAT AREA --- */
        #chat-bg {
            min-height: 100%;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; background-color: #0b141a;
            padding: 15px; display: flex; flex-direction: column; gap: 8px; 
        }

        .msg { 
            max-width: 65%; padding: 10px 14px; border-radius: 8px; font-size: 16px; 
            line-height: 1.4; position: relative; word-wrap: break-word; margin-bottom: 10px;
            display: block; clear: both;
        }
        
        .msg.in { background: #1f2c34; align-self: flex-start; float: left; margin-right: auto; border-top-left-radius: 0; }
        .msg.out { background: #005c4b; align-self: flex-end; float: right; margin-left: auto; border-top-right-radius: 0; }

        .chat-footer {
            height: 65px; background: #1f2c34; display: flex; align-items: center;
            padding: 5px 10px; flex-shrink: 0;
        }
        .input-box {
            flex: 1; background: #2a3942; border-radius: 25px; padding: 10px 20px;
            margin-right: 10px; display: flex; align-items: center;
        }
        #msg-input { width: 100%; background: transparent; border: none; color: white; font-size: 16px; }
        .send-btn {
            width: 45px; height: 45px; background: #00a884; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 18px; color: white;
        }

        /* AUTO ALERT */
        .auto-alert { width: 100%; background: rgba(0, 168, 132, 0.2); border: 1px solid #00a884; border-radius: 10px; padding: 12px; text-align: center; }
        .mini-map { width: 100%; height: 100px; background: #333; margin-top: 5px; background-size: cover; background-position: center; border-radius: 5px; }

        /* PULSING DOT (Current Location Style) */
        .pulse-icon {
            width: 16px; height: 16px; border-radius: 50%; background: #4285F4;
            border: 2px solid white; box-shadow: 0 0 0 10px rgba(66, 133, 244, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(66, 133, 244, 0); } 100% { box-shadow: 0 0 0 0 rgba(66, 133, 244, 0); } }

    </style>
</head>
<body>

<div id="app">

    <div id="screen-home" class="screen active">
        <div class="header">
            <span class="title">SafePing</span>
            <i class="fas fa-search" style="color:#8696a0; font-size:20px;"></i>
        </div>
        
        <div class="content">
            <div id="contact-list"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="nav('home')"><i class="fas fa-comment-alt"></i><span>Chats</span></div>
            <div class="tab" onclick="nav('config')"><i class="fas fa-cog"></i><span>Settings</span></div>
        </div>
    </div>

    <div id="screen-config" class="screen">
        <div class="header"><span class="title">Settings</span></div>
        <div class="content" style="padding:10px;">
            <div class="card">
                <div style="color:#ef4444; font-weight:bold; margin-bottom:5px;">BATTERY PROTOCOL</div>
                <div style="font-size:12px; color:#8696a0; margin-bottom:10px;">
                    Current Device Level: <span id="real-batt-level" style="color:white; font-weight:bold;">--%</span>
                </div>
                
                <select id="batt-contact" class="full-inp"></select>
                <input type="text" id="batt-msg" class="full-inp" value="Battery Critical. Call Landline.">
                
                <button class="test-btn" onclick="triggerBattery()">TEST BATTERY ALERT</button>
            </div>
            
            <div class="card">
                <div style="color:#00a884; font-weight:bold; margin-bottom:5px;">LOCATION PROTOCOL</div>
                
                <div id="map-box">
                    <div class="map-search-container">
                        <input type="text" id="loc-search" class="map-input" placeholder="Search destination...">
                        <button class="map-go-btn" onclick="searchLoc()">GO</button>
                    </div>
                    <div class="gps-btn" onclick="locateUser()">
                        <i class="fas fa-crosshairs"></i>
                    </div>
                </div>
                
                <select id="loc-contact" class="full-inp"></select>
                <input type="text" id="loc-msg" class="full-inp" value="I have reached safely.">
                
                <button class="test-btn" onclick="triggerLocation()">TEST LOCATION ALERT</button>
            </div>
        </div>
        <div class="tabs">
            <div class="tab" onclick="nav('home')"><i class="fas fa-comment-alt"></i><span>Chats</span></div>
            <div class="tab active" onclick="nav('config')"><i class="fas fa-cog"></i><span>Settings</span></div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div class="header">
            <div style="display:flex; align-items:center; width:100%;">
                <div class="back-click-area" onclick="closeChat()">
                    <i class="fas fa-arrow-left" style="font-size:24px; color: white;"></i>
                </div>
                <div class="avatar" id="chat-av" style="width:35px; height:35px; font-size:14px; margin-right:10px;"></div>
                <div style="flex:1;">
                    <div id="chat-title" style="font-weight:bold; font-size:16px;">Name</div>
                    <div style="font-size:12px; color:#8696a0">online</div>
                </div>
            </div>
        </div>

        <div class="content" id="chat-scroll">
            <div id="chat-bg">
                <div id="msg-list"></div>
            </div>
        </div>

        <div class="chat-footer">
            <div class="input-box">
                <input type="text" id="msg-input" placeholder="Message" autocomplete="off">
            </div>
            <div class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

</div>

<script>
    // --- MASSIVE CONTACT LIST ---
    const DB = [
        {name:"Mom ‚ù§Ô∏è", color:"#e91e63", last:"Be safe."},
        {name:"Dad", color:"#3b82f6", last:"Okay."},
        {name:"Rahul (Bro)", color:"#f59e0b", last:"Where r u?"},
        {name:"Priya Sharma", color:"#8b5cf6", last:"See you."},
        {name:"Amit Kumar", color:"#10b981", last:"Notes?"},
        {name:"Suresh Uncle", color:"#6366f1", last:"Hello."},
        {name:"Anjali Gupta", color:"#ec4899", last:"Done."},
        {name:"Emergency SOS", color:"#ef4444", last:"Active"},
        {name:"Cab Driver", color:"#64748b", last:"Arriving..."},
        {name:"College Group", color:"#f97316", last:"Exam tomorrow"},
        {name:"Neha Reddy", color:"#14b8a6", last:"Called you."},
        {name:"Vikram Singh", color:"#8b5cf6", last:"Coming?"},
        {name:"Deepak", color:"#f59e0b", last:"Yes."},
        {name:"Office", color:"#334155", last:"Meeting at 5"},
        {name:"Gym Trainer", color:"#ef4444", last:"Leg day"}
    ];

    let map, marker, currentUserMarker, activeContact;
    let config = { batt: { to:"Mom ‚ù§Ô∏è", msg:"Battery Low."}, loc: { to:"Dad", msg:"Reached safely."} };

    window.onload = () => {
        renderContacts(DB);
        populateSettings();
        initBattery(); 
    };

    function renderContacts(list) {
        const div = document.getElementById('contact-list');
        div.innerHTML = "";
        list.forEach(c => {
            const el = document.createElement('div');
            el.className = 'contact-item';
            el.onclick = () => openChat(c.name); 
            el.innerHTML = `
                <div class="avatar" style="background:${c.color}">${c.name[0]}</div>
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:16px; margin-bottom:2px;">${c.name}</div>
                    <div style="color:#8696a0; font-size:14px;">${c.last}</div>
                </div>
            `;
            div.appendChild(el);
        });
    }

    function populateSettings() {
        const opts = DB.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        document.getElementById('batt-contact').innerHTML = opts;
        document.getElementById('loc-contact').innerHTML = opts;
    }

    function nav(screen) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        if(screen === 'home') {
            document.getElementById('screen-home').classList.add('active');
            document.querySelectorAll('.tab')[0].classList.add('active');
        } else {
            document.getElementById('screen-config').classList.add('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
            setTimeout(initMap, 200);
        }
    }

    function openChat(name) {
        activeContact = name;
        const c = DB.find(x => x.name === name);
        
        document.getElementById('screen-home').classList.remove('active');
        document.getElementById('screen-config').classList.remove('active');
        document.getElementById('screen-chat').classList.add('active');

        document.getElementById('chat-title').innerText = c.name;
        document.getElementById('chat-av').innerText = c.name[0];
        document.getElementById('chat-av').style.background = c.color;
        
        document.getElementById('msg-list').innerHTML = `
            <div class="msg in">Hey ${name.split(' ')[0]} here.</div>
            <div class="msg out">${c.last}</div>
        `;
    }

    function closeChat() {
        document.getElementById('screen-chat').classList.remove('active');
        document.getElementById('screen-home').classList.add('active');
    }

    function sendMsg() {
        const inp = document.getElementById('msg-input');
        if(!inp.value) return;
        addMsg(inp.value, 'out'); 
        inp.value = "";
    }

    function addMsg(txt, type, isHTML=false) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        if(isHTML) div.innerHTML = txt; else div.innerText = txt;
        document.getElementById('msg-list').appendChild(div);
        const scroll = document.getElementById('chat-scroll');
        scroll.scrollTop = scroll.scrollHeight;
    }

    // --- REAL BATTERY ---
    function initBattery() {
        if ('getBattery' in navigator) {
            navigator.getBattery().then(function(battery) {
                updateBattUI(battery);
                battery.addEventListener('levelchange', function() { updateBattUI(battery); });
            });
        }
    }

    function updateBattUI(battery) {
        const level = Math.round(battery.level * 100);
        document.getElementById('real-batt-level').innerText = level + "%";
        if(level <= 10) triggerBattery(); 
    }

    function triggerBattery() {
        config.batt.to = document.getElementById('batt-contact').value;
        config.batt.msg = document.getElementById('batt-msg').value;

        if(activeContact !== config.batt.to) openChat(config.batt.to);

        addMsg(`
            <div class="auto-alert" style="border-color:#ef4444; background:rgba(239,68,68,0.2)">
                <b style="color:#ef4444">‚ö° LOW BATTERY</b><br>
                <div style="font-size:14px; color:#e9edef; margin-top:5px;">${config.batt.msg}</div>
            </div>
        `, 'out', true); 
    }

    function triggerLocation() {
        config.loc.to = document.getElementById('loc-contact').value;
        config.loc.msg = document.getElementById('loc-msg').value;

        if(activeContact !== config.loc.to) openChat(config.loc.to);
        
        addMsg(`
            <div class="auto-alert">
                <b style="color:#00a884">üìç ARRIVED</b><br>
                <div style="font-size:14px; color:#e9edef; margin-top:5px;">${config.loc.msg}</div>
                <div class="mini-map" style="background-image:url('https://a.basemaps.cartocdn.com/dark_all/13/5000/3000.png')"></div>
            </div>
        `, 'out', true); 
    }

    // --- GOOGLE MAPS STYLE LOGIC ---
    function initMap() {
        if(map) { map.invalidateSize(); return; }
        map = L.map('map-box').setView([20.59, 78.96], 10); // Zoomed out initially
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution:''}).addTo(map);
    }

    // 1. SEARCH AND DROP RED PIN (DESTINATION)
    function searchLoc() {
        const q = document.getElementById('loc-search').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`).then(r=>r.json()).then(d=>{
            if(d.length){ 
                map.setView([d[0].lat, d[0].lon], 14); 
                if(marker) map.removeLayer(marker); 
                marker=L.marker([d[0].lat, d[0].lon]).addTo(map).bindPopup("Destination").openPopup(); 
            }
        });
    }

    // 2. LOCATE ME (BLUE DOT)
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Fly to location
                map.setView([lat, lng], 15);

                // Add Blue Pulsing Dot
                if(currentUserMarker) map.removeLayer(currentUserMarker);
                
                var blueDot = L.divIcon({
                    className: 'pulse-icon',
                    iconSize: [16, 16]
                });
                
                currentUserMarker = L.marker([lat, lng], {icon: blueDot}).addTo(map).bindPopup("You are here").openPopup();

            }, () => {
                alert("Location access denied or unavailable.");
            });
        } else {
            alert("Browser does not support Geolocation");
        }
    }

</script>
</body>
</html>
