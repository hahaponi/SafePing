<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafePing Final</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html {
            background-color: #0b141a;
            height: 100%; width: 100%;
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #e9edef;
            overflow: hidden;
            position: fixed;
        }

        #app { width: 100%; height: 100%; position: relative; display: flex; flex-direction: column; }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b141a; display: none; flex-direction: column;
            z-index: 10;
        }
        .screen.active { display: flex; }

        /* CHAT SCREEN (High Z-Index) */
        #screen-chat { z-index: 100; background: #0b141a; }

        /* --- HEADER --- */
        .header {
            height: 60px; background: #1f2c34; display: flex; align-items: center;
            justify-content: space-between; padding: 0 15px; flex-shrink: 0;
            z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .title { font-size: 20px; font-weight: 600; color: white; }

        /* --- BACK BUTTON (CRITICAL FIX) --- */
        .back-click-area {
            padding: 10px 20px 10px 0; /* Large click area */
            cursor: pointer;
            display: flex; align-items: center;
        }

        /* --- TABS --- */
        .tabs { height: 60px; background: #1f2c34; display: flex; border-top: 1px solid #333; flex-shrink: 0; }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8696a0; }
        .tab.active { color: #00a884; }
        .tab i { font-size: 24px; margin-bottom: 4px; }

        /* --- CONTENT SCROLL --- */
        .content { flex: 1; overflow-y: auto; position: relative; }

        /* --- CONTACT LIST --- */
        .contact-item {
            display: flex; align-items: center; padding: 15px;
            border-bottom: 1px solid rgba(134,150,160,0.15); cursor: pointer;
        }
        .contact-item:active { background: #202c33; }
        .avatar {
            width: 50px; height: 50px; border-radius: 50%; background: #667781;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: white; flex-shrink: 0;
        }

        /* --- SETTINGS --- */
        .card { background: #1f2c34; margin: 15px; padding: 15px; border-radius: 12px; }
        .full-inp { width: 100%; background: #2a3942; border: 1px solid #374045; color: white; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 16px; }
        #map-box { height: 150px; width: 100%; border-radius: 8px; margin: 10px 0; }
        
        /* --- CHAT AREA (ALIGNMENT FIX) --- */
        #chat-bg {
            min-height: 100%;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; background-color: #0b141a;
            padding: 15px; 
            display: flex; 
            flex-direction: column; /* Stack messages vertically */
            gap: 8px; 
        }

        /* MESSAGE BUBBLES */
        .msg { 
            max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 16px; 
            color: white; line-height: 1.4; position: relative; word-wrap: break-word; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        /* RECEIVER (MOM/DAD) -> LEFT */
        .msg.in { 
            background: #1f2c34; 
            align-self: flex-start; /* CRITICAL ALIGNMENT FIX */
            border-top-left-radius: 0; 
        }
        
        /* SENDER (YOU) -> RIGHT */
        .msg.out { 
            background: #005c4b; 
            align-self: flex-end; /* CRITICAL ALIGNMENT FIX */
            border-top-right-radius: 0; 
        }

        /* CHAT INPUT */
        .chat-footer {
            height: 65px; background: #1f2c34; display: flex; align-items: center;
            padding: 5px 10px; flex-shrink: 0;
        }
        .input-box {
            flex: 1; background: #2a3942; border-radius: 25px; padding: 10px 20px;
            margin-right: 10px; display: flex; align-items: center;
        }
        #msg-input { width: 100%; background: transparent; border: none; color: white; font-size: 16px; }
        .send-btn {
            width: 45px; height: 45px; background: #00a884; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 18px; color: white;
        }

        /* AUTO ALERT */
        .auto-alert {
            width: 90%; align-self: center; background: rgba(0, 168, 132, 0.2);
            border: 1px solid #00a884; border-radius: 10px; padding: 12px;
            text-align: center; margin: 10px 0;
        }
        .mini-map { width: 100%; height: 100px; background: #333; margin-top: 5px; background-size: cover; background-position: center; border-radius: 5px; }

    </style>
</head>
<body>

<div id="app">

    <div id="screen-home" class="screen active">
        <div class="header">
            <span class="title">SafePing</span>
            <i class="fas fa-search" style="color:#8696a0; font-size:20px;"></i>
        </div>
        
        <div class="content">
            <div id="contact-list"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="nav('home')"><i class="fas fa-comment-alt"></i><span>Chats</span></div>
            <div class="tab" onclick="nav('config')"><i class="fas fa-cog"></i><span>Settings</span></div>
        </div>
    </div>

    <div id="screen-config" class="screen">
        <div class="header"><span class="title">Settings</span></div>
        <div class="content" style="padding:10px;">
            <div class="card">
                <div style="color:#ef4444; font-weight:bold; margin-bottom:5px;">BATTERY PROTOCOL</div>
                <div style="color:#8696a0; font-size:12px; margin-bottom:10px;">Move slider to test triggering</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="range" id="batt-slider" style="width:75%" min="1" max="100" value="85" oninput="updateBattery(this.value)">
                    <span id="b-val" style="color:#ef4444; font-weight:bold;">85%</span>
                </div>
                <select id="batt-contact" class="full-inp"></select>
                <input type="text" id="batt-msg" class="full-inp" value="Battery Low. Call Landline.">
            </div>
            
            <div class="card">
                <div style="color:#00a884; font-weight:bold; margin-bottom:5px;">LOCATION PROTOCOL</div>
                <div id="map-box"></div>
                <button onclick="triggerLocation()" style="background:#2a3942; color:#00a884; border:1px solid #00a884; padding:8px; width:100%; border-radius:8px; margin-bottom:10px;">TEST LOCATION RULE</button>
                <select id="loc-contact" class="full-inp"></select>
                <input type="text" id="loc-msg" class="full-inp" value="Reached safely.">
            </div>
        </div>
        <div class="tabs">
            <div class="tab" onclick="nav('home')"><i class="fas fa-comment-alt"></i><span>Chats</span></div>
            <div class="tab active" onclick="nav('config')"><i class="fas fa-cog"></i><span>Settings</span></div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div class="header">
            <div style="display:flex; align-items:center; width:100%;">
                <div class="back-click-area" onclick="closeChat()">
                    <i class="fas fa-arrow-left" style="font-size:24px; color: white;"></i>
                </div>
                
                <div class="avatar" id="chat-av" style="width:35px; height:35px; font-size:14px; margin-right:10px;"></div>
                <div style="flex:1;">
                    <div id="chat-title" style="font-weight:bold; font-size:16px;">Name</div>
                    <div style="font-size:12px; color:#8696a0">online</div>
                </div>
            </div>
        </div>

        <div class="content" id="chat-scroll">
            <div id="chat-bg">
                <div id="msg-list"></div>
            </div>
        </div>

        <div class="chat-footer">
            <div class="input-box">
                <input type="text" id="msg-input" placeholder="Message" autocomplete="off">
            </div>
            <div class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

</div>

<script>
    const DB = [
        {name:"Mom ‚ù§Ô∏è", color:"#e91e63", last:"Be safe."},
        {name:"Dad", color:"#3b82f6", last:"Okay."},
        {name:"Rahul", color:"#f59e0b", last:"Where r u?"},
        {name:"Priya", color:"#8b5cf6", last:"See you."},
        {name:"Amit", color:"#10b981", last:"Notes?"}
    ];

    let map, marker, activeContact;
    let config = { batt: { to:"Mom ‚ù§Ô∏è", msg:"Battery Low."}, loc: { to:"Dad", msg:"Reached safely."} };

    window.onload = () => {
        renderContacts();
        populateSettings();
    };

    function renderContacts() {
        const list = document.getElementById('contact-list');
        list.innerHTML = "";
        DB.forEach(c => {
            const el = document.createElement('div');
            el.className = 'contact-item';
            el.onclick = () => openChat(c.name); 
            el.innerHTML = `
                <div class="avatar" style="background:${c.color}">${c.name[0]}</div>
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:16px; margin-bottom:2px;">${c.name}</div>
                    <div style="color:#8696a0; font-size:14px;">${c.last}</div>
                </div>
            `;
            list.appendChild(el);
        });
    }

    function populateSettings() {
        const opts = DB.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        document.getElementById('batt-contact').innerHTML = opts;
        document.getElementById('loc-contact').innerHTML = opts;
    }

    function nav(screen) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        if(screen === 'home') {
            document.getElementById('screen-home').classList.add('active');
            document.querySelectorAll('.tab')[0].classList.add('active');
        } else {
            document.getElementById('screen-config').classList.add('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
            setTimeout(initMap, 200);
        }
    }

    function openChat(name) {
        activeContact = name;
        const c = DB.find(x => x.name === name);
        
        // SWITCH SCREENS
        document.getElementById('screen-home').classList.remove('active');
        document.getElementById('screen-config').classList.remove('active');
        document.getElementById('screen-chat').classList.add('active');

        document.getElementById('chat-title').innerText = c.name;
        document.getElementById('chat-av').innerText = c.name[0];
        document.getElementById('chat-av').style.background = c.color;
        
        // Reset Chat with Receiver Message on LEFT
        document.getElementById('msg-list').innerHTML = `
            <div class="msg in">Hey ${name.split(' ')[0]} here.</div>
            <div class="msg out">${c.last}</div>
        `;
    }

    function closeChat() {
        document.getElementById('screen-chat').classList.remove('active');
        document.getElementById('screen-home').classList.add('active');
        // Reset tabs visually
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab')[0].classList.add('active');
    }

    function sendMsg() {
        const inp = document.getElementById('msg-input');
        if(!inp.value) return;
        addMsg(inp.value, 'out'); // Sender on RIGHT
        inp.value = "";
    }

    function addMsg(txt, type, isHTML=false) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        if(isHTML) div.innerHTML = txt; else div.innerText = txt;
        document.getElementById('msg-list').appendChild(div);
        
        // Scroll
        const scroll = document.getElementById('chat-scroll');
        scroll.scrollTop = scroll.scrollHeight;
    }

    // --- AUTOMATION SIMULATION ---
    
    // 1. BATTERY LOGIC (Use Slider in Settings to Sim)
    function updateBattery(val) {
        document.getElementById('b-val').innerText = val + "%";
        if(val <= 10) {
            triggerBattery();
        }
    }

    function triggerBattery() {
        // Auto Update Config
        config.batt.to = document.getElementById('batt-contact').value;
        config.batt.msg = document.getElementById('batt-msg').value;

        // Open Chat if not already open
        if(activeContact !== config.batt.to) openChat(config.batt.to);

        addMsg(`
            <div class="auto-alert" style="border-color:#ef4444; background:rgba(239,68,68,0.2)">
                <b style="color:#ef4444">‚ö° LOW BATTERY</b><br>
                <div style="font-size:14px; color:#e9edef; margin-top:5px;">${config.batt.msg}</div>
            </div>
        `, 'out', true); // ALIGN RIGHT
    }

    // 2. LOCATION LOGIC (Use Button in Settings to Sim)
    function triggerLocation() {
        // Auto Update Config
        config.loc.to = document.getElementById('loc-contact').value;
        config.loc.msg = document.getElementById('loc-msg').value;

        // Open Chat if not already open
        if(activeContact !== config.loc.to) openChat(config.loc.to);
        
        addMsg(`
            <div class="auto-alert">
                <b style="color:#00a884">üìç ARRIVED</b><br>
                <div style="font-size:14px; color:#e9edef; margin-top:5px;">${config.loc.msg}</div>
                <div class="mini-map" style="background-image:url('https://a.basemaps.cartocdn.com/dark_all/13/5000/3000.png')"></div>
            </div>
        `, 'out', true); // ALIGN RIGHT
    }

    function initMap() {
        if(map) { map.invalidateSize(); return; }
        map = L.map('map-box').setView([20.59, 78.96], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution:''}).addTo(map);
    }
</script>
</body>
</html>
